# -*- coding: utf-8 -*-
"""Sales_prediction_.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uU8U9rm2_a-RDlLFSiCyrCn_bFJRyB0x
"""

import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib as mpl
import matplotlib.pyplot as plt
import plotly.express as px # Library for 3d viewing
import plotly.figure_factory as ff
from sklearn.model_selection import GridSearchCV
from sklearn import linear_model
from sklearn.preprocessing import StandardScaler
from sklearn.preprocessing import MinMaxScaler
from sklearn.linear_model import SGDRegressor
from sklearn import metrics as mt
from sklearn.model_selection import train_test_split as tt
from sklearn.model_selection import cross_val_score
from sklearn.metrics import mean_squared_error

ds = pd.read_csv('sales_data_sample.csv', sep=",", encoding='Latin-1')
ds

ds.info()

ds.isnull().sum()

df = ds.drop(columns=['ADDRESSLINE2', 'STATE','TERRITORY'])
df

df.isnull().sum()

df1 = df[pd.notnull(df['POSTALCODE'])]
df1

df1.duplicated().count()

df1.drop_duplicates()

df1.nunique()

df1.columns

dfsns = df1.sample(100)
dfsns

sns.regplot(x = 'ORDERNUMBER', y = 'SALES', data = dfsns);

sns.regplot(x = 'QUANTITYORDERED', y = 'SALES', data = dfsns);

sns.regplot(x = 'PRICEEACH', y = 'SALES', data = dfsns);

sns.regplot(x = 'ORDERLINENUMBER', y = 'SALES', data = dfsns);

sns.regplot(x = 'ORDERDATE', y = 'SALES', data = dfsns);

sns.regplot(x = 'QTR_ID', y = 'SALES', data = dfsns);

sns.regplot(x = 'MONTH_ID', y = 'SALES', data = dfsns);

sns.regplot(x = 'YEAR_ID', y = 'SALES', data = dfsns);

sns.regplot(x = 'PRODUCTLINE', y = 'SALES', data = dfsns);

sns.regplot(x = 'MSRP', y = 'SALES', data = dfsns);

sns.regplot(x = 'PRODUCTCODE', y = 'SALES', data = dfsns);

sns.regplot(x = 'CUSTOMERNAME', y = 'SALES', data = dfsns);

sns.regplot(x = 'PHONE', y = 'SALES', data = dfsns);

sns.regplot(x = 'ADDRESSLINE1', y = 'SALES', data = dfsns);

sns.regplot(x = 'CITY', y = 'SALES', data = dfsns);

sns.regplot(x = 'POSTALCODE', y = 'SALES', data = dfsns);

sns.regplot(x = 'CONTACTLASTNAME', y = 'SALES', data = dfsns);

sns.regplot(x = 'CONTACTFIRSTNAME', y = 'SALES', data = dfsns);

sns.regplot(x = 'DEALSIZE', y = 'SALES', data = dfsns);

cor = dfsns.corr()
cor

figure = ff.create_annotated_heatmap(
    z=cor.values,
    x=list(cor.columns),
    y=list(cor.index),
    annotation_text=cor.round(2).values,
    showscale=True)
figure.show()

dfsns.columns

X = dfsns.drop(['ORDERNUMBER','ORDERLINENUMBER','SALES', 'ORDERDATE', 'STATUS', 'QTR_ID', 'MONTH_ID', 'YEAR_ID',
       'PRODUCTLINE', 'PRODUCTCODE', 'CUSTOMERNAME', 'PHONE', 'ADDRESSLINE1', 'CITY', 'POSTALCODE', 'COUNTRY', 'CONTACTLASTNAME',
       'CONTACTFIRSTNAME', 'DEALSIZE'], axis = 1) #Features
y = dfsns['SALES'] #Labels

print(type(X))
print(type(y))
print(X.shape)
print(y.shape)

scale = StandardScaler()
scaledX = scale.fit_transform(X)
scaledX

X_train, X_test, y_train, y_test = tt(scaledX,y, test_size=0.20, random_state=40)
print(X_train.shape, y_train.shape)
print(X_test.shape, y_test.shape)

scaler = MinMaxScaler()

scl = dfsns[['QUANTITYORDERED','PRICEEACH','MSRP']] = scaler.fit_transform(dfsns[['QUANTITYORDERED','PRICEEACH','MSRP']])
scl

LR = linear_model.LinearRegression()
LR.fit(X_train, y_train)

pred = LR.predict(X_test)

score = LR.score(X_test,y_test)
score

print(LR.coef_)
print(LR.intercept_)

LR.coef_[0]*500+LR.coef_[1]*5+LR.coef_[2]*0.2+LR.intercept_

error = mt.mean_squared_error(y_test, pred)
rmse = np.sqrt(error)
print('Root MSE :', rmse)

mt.r2_score(y_test, pred)

LR2 = linear_model.LinearRegression()
cv_results = cross_val_score(LR2, scaledX, y, cv=5)
print('Cross Validation Results\t: ', cv_results)
average_score = np.mean(cv_results)
print('Avg. Score\t\t\t: ', average_score)

lasso = linear_model.Lasso(alpha=0.01, max_iter=10000)
lasso.fit(X_train, y_train)
lasso_predict = lasso.predict(X_test)
lasso.score(X_test, y_test)

sgdr = SGDRegressor(random_state = 1, penalty = None, eta0=.0001, max_iter=1000)
grid_param = {'eta0': [.0001, .001, .01, .1, 1], 'max_iter':[10000, 20000, 30000, 40000]}
gd_sr = GridSearchCV(estimator=sgdr, param_grid=grid_param, scoring='r2', cv=5)

gd_sr.fit(scaledX, y)

results = pd.DataFrame.from_dict(gd_sr.cv_results_)
print("Cross-validation results:\n", results)

best_parameters = gd_sr.best_params_
print("\nBest parameters\t: ", best_parameters)

best_result = gd_sr.best_score_ # Mean cross-validated score of the best_estimator
print("Best result\t: ", best_result)

best_model = gd_sr.best_estimator_
print("Intercept\t: ", best_model.intercept_)

sgdr.fit(scaledX,y)
print('Intercept\t:', sgdr.intercept_)
print('score\t\t:', sgdr.score(scaledX, y))
print('\n', pd.DataFrame(zip(X.columns, best_model.coef_), columns=['Features','Coefficients']).sort_values(by=['Coefficients'], ascending=False))
print('\n\nSGDR Score\t: ', sgdr.score(scaledX, y))

best_model.coef_[0]*500+best_model.coef_[1]*5+best_model.coef_[2]*0.2+sgdr.intercept_

